#!/bin/bash

arr=$(echo $1 | tr ":" "\n")

code=0

pwd=`pwd`
files=`find * -maxdepth 3 -name catalog.xml -printf '%h\0%d\0%p\n' | sort -t '\0' -n | awk -F '\0' '{print $3}'`
catalogs=""
while read -r catalog; do
    catalogs=$catalogs$pwd/$catalog" "
done <<< "$files"

for schema in $arr
    do
	cats=$catalogs
	vxeschemas=`cat $schema | gawk '{ match($0, /"urn:visualXMLeditor:schema:(.+)"/, arr); if(arr[1] != "") print arr[1] }'`
	if [ ! -z "$vxeschemas" ]; then
	    vxecatalog="/tmp/"`/usr/bin/md5sum $schema | cut -f1 -d' '`".xml"
	    echo '<?xml version="1.0"?>' > $vxecatalog
	    echo '<!DOCTYPE catalog PUBLIC "-//OASIS//DTD Entity Resolution XML Catalog V1.0//EN" "http://www.oasis-open.org/committees/entity/release/1.0/catalog.dtd">' >> $vxecatalog
	    echo '<catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog">' >> $vxecatalog
	    for stub in $vxeschemas
		do
		    stubfile="/tmp/"`echo $stub | /usr/bin/md5sum | /usr/bin/cut -f1 -d ' '`".xsd"
		    echo '  <uri name="urn:visualXMLeditor:schema:'$stub'" uri="'$stubfile'"/>' >> $vxecatalog
		    echo '<?xml version="1.0" encoding="utf-8"?>' > $stubfile
		    echo '<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"><xs:group name="'$stub'"><xs:sequence><xs:element name="'$stub'"><xs:complexType><xs:sequence><xs:any minOccurs="0" maxOccurs="unbounded" processContents="lax"/></xs:sequence></xs:complexType></xs:element></xs:sequence></xs:group></xs:schema>' >> $stubfile
		done
	    echo '</catalog>' >> $vxecatalog
	    cats=$cats" "$vxecatalog
	fi

	dir=$(dirname $schema)
	basename=$(basename $schema)
	cd $dir
	if [ -f "catalog.xml" ]; then
	    out=`XML_CATALOG_FILES=catalog.xml /usr/bin/xmllint --noout --auto --schema $basename 2>&1`
	else
	    out=`XML_CATALOG_FILES="$cats" /usr/bin/xmllint --noout --auto --schema $basename 2>&1`
	fi

	if [ $? -eq 5 ]; then
	    echo $out
	    code=1
	fi

	if [ ! -z "$vxeschemas" ]; then
	    vxecatalog="/tmp/"`/usr/bin/md5sum $schema | cut -f1 -d' '`".xml"
	    /usr/bin/rm $vxecatalog
	    for stub in $vxeschemas
		do
		    stubfile="/tmp/"`echo $stub | /usr/bin/md5sum | /usr/bin/cut -f1 -d ' '`".xsd"
		    /usr/bin/rm $stubfile
		done
	fi

    done

if [ $code -eq 0 ]; then
    echo "All schemas are valid"
fi

exit $code
